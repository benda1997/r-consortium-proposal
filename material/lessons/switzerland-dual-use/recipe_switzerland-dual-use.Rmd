---
title: "Recipe for analysis of the dual-use data"
author: "Heidi Seibold"
date: "April 25, 2017"
output: html_document
---
```{r}
knitr::opts_chunk$set(message = FALSE)
```


Dual-use goods are goods that can be used for civil and military purposes. 
In Switzerland, these goods are governed with a special legislation – 
unlike in other countries, where they are looked at as conventional arms exports. 

The state secretariat for economic affairs (SECO) in Switzerland decides which
dual-use goods may be exported and also 
[provides the data](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html) 
after each quarter.

The [SRF data](srf.ch/data) team - the data journalism team of Swiss Radio and TV -
has been repeatedly analysing this data in the past years. 
The reasons for using R for this task are various:

- R can read in Excel data (SECO provides the data in xlsx format)
- R allows for automation of data cleaning and analyses that have to be repeated
- R can export data to csv so it can be used in other programs (e.g. Excel)
- R produces good graphics and allows for individualised themes
- R allows you to document how you have transformed the data to be accountable on your work to the readers 
- With R reproducible documents (e.g. HTML or PDF) can be created, changes are 
  included without major efforts

You can find the entire analysis on the [SRF data GitHub repository](https://github.com/srfdata/2017-01-dual-use)
and the article from January 2017 on the 
[SRF website](http://www.srf.ch/news/schweiz/schweiz-bewilligt-millionendeal-mit-dem-irak).



# Ask

At the beginning of 2017 SRF data analyst Timo Grossenbacher wanted to answer the 
question   
**Which dual-use goods were exported to which countries in each quarter of the 
years 2012 to 2016?**

Having cleaned and visualised the data he realised that suddenly in 2016 Switzerland started exporting 
dual-use goods to Irak after not having done so in the years prior. This became the story
in the January 2017 [article](http://www.srf.ch/news/schweiz/schweiz-bewilligt-millionendeal-mit-dem-irak) .

We want to answer the same question and in order to have a clean project, create
a new folder on your computer in which you will store all details on this project.
We propose the following:

- Create a folder called `switzerland-dual-use`
- Within this folder create another two more folders called `data_raw` and `data_clean`

```{}
└── switzerland-dual-use
    ├── data_clean
    └── data_raw
```


# Find

The data can be found (in German) on the [SECO website](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html). SRF also keeps the data available in their [GitHub repo](https://github.com/srfdata/2017-01-dual-use/tree/master/analysis/input).



# Get

The data can be downloaded simply clicking on the data links on the 
[SECO website](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html). Get the data and store it in Folder `data_raw`.

Yor file structure should now look like this,
```{}
└── switzerland-dual-use
    ├── data_clean
    └── data_raw
        ├── 1_Quartal_2016_Bewilligungen.xlsx
        ├── 2. Quartal 2016 Erteilte Ausfuhrbewilligungen.xlsx
        ├── 3. Quartal 2016 Erteilte Ausfuhrbewilligungen.xlsx
        ├── 4. Quartal 2016 Erteilte Ausfuhrbewilligungen.xlsx
        ├── Stat_IP_2015_Bewilligungen.xlsx
        ├── Statistik Dual-Use 2014 Elic.xlsx
        ├── Statistik Dual-Use Jan. 2012 - Sep. 2014 Tracker.xlsx
        └── Statistik ML 2005-2013.xlsx
```
i.e. you should have the dual-use Excel files corresponding to years 2012 to 2016.

Let's try reading in the data of first two quarters of 2016:

1. Open your R editor (e.g. RStudio) 
2. Set your working directory to the `switzerland-dual-use` directory. 
To do this first enter 
```{r, eval=FALSE}
getwd()
```
in the console. This will show your current working directory.
E.g. for me it shows `[1] "/home/heidi/Documents"`. Next use `setwd()` to change 
to the correct diretory. For me it is `/home/heidi/Documents/switzerland-dual-use` 
and so I have to type
```{r, eval=FALSE}
setwd("switzerland-dual-use")
```
or equivalently 
```{r, eval=FALSE}
setwd("/home/heidi/Documents/switzerland-dual-use")
```

To read Excel data into R, we need a specialised R package, which is called
`readxl`. To install the package run
```{r, eval=FALSE}
install.packages("readxl")
```
To load the package run
```{r}
library("readxl") 
```
Now we can read the data of the first two quarters of 2016:
```{r}
elic_2016_1_raw <- read_excel(path = "data_raw/1_Quartal_2016_Bewilligungen.xlsx")
elic_2016_2_raw <- read_excel(path = "data_raw/2. Quartal 2016 Erteilte Ausfuhrbewilligungen.xlsx")
```

# Verify
To check whether reading in worked and the data is what we wanted, there are a 
couple of useful commands in R. Let's now first work with `elic_2016_1_raw`:

- `names()` shows the collumn names of the data frame
```{r}
names(elic_2016_1_raw)
```
- `head()` shows the first few rows of the data frame
```{r}
head(elic_2016_1_raw)
```
- `tail()` shows the last few rows of the data frame
```{r}
tail(elic_2016_1_raw)
```
- `summary()` shows a summary of the data. For numeric variables such as the price (`Wert [CHF]`) it 
shows the [five number summary](https://en.wikipedia.org/wiki/Five-number_summary) and the mean (average).
For character variables such as receiving country (`Bestimmungsland`) it shows the length and the information
that it is a character variable.
```{r}
summary(elic_2016_1_raw)
```
- `str()` shows the type of each variable (here `num` for numeric and `chr` for character) and the
first few values
```{r}
str(elic_2016_1_raw)
```


# Clean

```{r}
library("dplyr")   ## if not available install by typing install.packages("dplyr")

elic_2016_1_1 <- elic_2016_1_raw %>% 
  mutate(Datum = as.Date("2016-01-01 00:00:01")) %>% 
  mutate(Quartal = paste(format(Datum, "%y"), sprintf("%02i", (as.POSIXlt(Datum)$mon) %/% 3L + 1L), sep="/"))
str(elic_2016_1_1)

elic_2016_1_2 <- elic_2016_1_1 %>% select(GN = Geschäftsnummer, 
                                          Datum, 
                                          Quartal, 
                                          Land = Bestimmungsland, 
                                          Wert = `Wert [CHF]`, 
                                          Position_Gueterart = Güterart, 
                                          Position_EKN = `Exportkontrollnummer [EKN]`, 
                                          Art = Richtung)
str(elic_2016_1_2)

elic_2016_1_3 <- elic_2016_1_2 %>% filter(Art == "Ausfuhr")
str(elic_2016_1_3)

elic_2016_1_4 <- elic_2016_1_3 %>% select(-Art)
str(elic_2016_1_4)


# elic_2016_2 <- elic_2016_2_raw %>% 
#   mutate(Datum = as.Date("2016-04-01 00:00:01")) %>% 
#   mutate(Quartal = paste(format(Datum, "%y"), sprintf("%02i", (as.POSIXlt(Datum)$mon) %/% 3L + 1L), sep="/")) %>%
#   select(GN = Geschäftsnummer, Datum, Quartal, Land = Bestimmungsland, Wert = `Wert [CHF]`, Position_Gueterart = Güterart, Position_EKN = `Exportkontrollnummer [EKN]`, Art = Richtung) %>% 
#   filter(Art == "Ausfuhr") %>% 
#   select(-Art)
```

